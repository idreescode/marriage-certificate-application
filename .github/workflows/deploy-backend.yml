name: Deploy Backend to IONOS Server

on:
  push:
    branches: [main, master]
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üìù Create .env file
        working-directory: ./backend
        run: |
          cat > .env << EOF
          PORT=${{ secrets.BACKEND_PORT || '5000' }}
          NODE_ENV=production
          DB_HOST=${{ secrets.DB_HOST }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_NAME=${{ secrets.DB_NAME }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          EMAIL_HOST=${{ secrets.EMAIL_HOST }}
          EMAIL_PORT=${{ secrets.EMAIL_PORT }}
          EMAIL_USER=${{ secrets.EMAIL_USER }}
          EMAIL_PASS=${{ secrets.EMAIL_PASS }}
          FRONTEND_URL=${{ secrets.FRONTEND_URL || 'https://nikahapp.jamiyat.org' }}
          API_TOKEN=${{ secrets.API_TOKEN }}
          EOF
          echo "‚úÖ .env file created"

      - name: üîß Install sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

      - name: üîç Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: üì§ Deploy to server
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          # Create deployment script
          REPO_URL="https://github.com/${{ github.repository }}.git"
          cat > deploy-backend.sh << EOF
          #!/bin/bash
          set -e
          
          echo "üöÄ Starting backend deployment..."
          
          # Create backend directory if it doesn't exist
          if [ ! -d "/var/www/backend" ]; then
            echo "üìÅ Creating /var/www/backend directory..."
            mkdir -p /var/www/backend
            chmod 755 /var/www/backend
          fi
          
          # Navigate to backend directory
          cd /var/www/backend || exit 1
          
          # Initialize git repository if it doesn't exist
          if [ ! -d ".git" ]; then
            echo "üîß Initializing git repository..."
            git init
            git remote add origin $REPO_URL || git remote set-url origin $REPO_URL
          else
            # Ensure remote is correct
            git remote set-url origin $REPO_URL
          fi
          
          # Backup current .env if exists
          if [ -f .env ]; then
            cp .env .env.backup.\$(date +%Y%m%d_%H%M%S)
            echo "‚úÖ Backed up existing .env"
          fi
          
          # Pull latest code
          echo "üì• Pulling latest code..."
          
          # Determine branch name
          BRANCH_NAME="main"
          if ! git ls-remote --heads origin main 2>/dev/null | grep -q "refs/heads/main"; then
            BRANCH_NAME="master"
          fi
          
          echo "üìå Target branch: \$BRANCH_NAME"
          
          # Fetch latest changes
          git fetch origin --force --prune
          git fetch origin \$BRANCH_NAME --force
          
          # Checkout and reset to latest
          git checkout -f \$BRANCH_NAME 2>/dev/null || git checkout -b \$BRANCH_NAME origin/\$BRANCH_NAME
          git reset --hard origin/\$BRANCH_NAME
          
          # Note: We don't run git clean -fd to preserve .env and other untracked files
          echo "‚úÖ Latest code pulled. New commit:"
          git log -1 --oneline
          
          # Move backend files from subdirectory to root if needed
          if [ -d "backend" ] && [ ! -f "package.json" ]; then
            echo "üì¶ Moving backend files to root..."
            cp -a backend/. . 2>/dev/null || cp -r backend/* . 2>/dev/null || true
            rm -rf backend
            echo "‚úÖ Backend files moved"
          fi
          
          # Remove frontend folder
          [ -d "frontend" ] && rm -rf frontend
          
          # Verify package.json exists
          if [ ! -f "package.json" ]; then
            echo "‚ùå Error: package.json not found!"
            echo "Current directory contents:"
            ls -la
            exit 1
          fi
          
          echo "‚úÖ Verified: package.json found at \$(pwd)/package.json"
          
          # Create uploads directory if it doesn't exist
          if [ ! -d "uploads" ]; then
            echo "üìÅ Creating uploads directory..."
            mkdir -p uploads/receipts uploads/certificates
            chmod -R 755 uploads
          fi
          
          # Install/update dependencies
          echo "üì¶ Installing dependencies..."
          # Clear npm cache to ensure fresh install
          npm cache clean --force 2>/dev/null || true
          # Always use npm install (simpler, handles lock file sync automatically)
          npm install --omit=dev
          echo "‚úÖ Dependencies installed"
          
          # Verify .env file exists before migrations
          echo "üîç Verifying .env file before migrations..."
          if [ ! -f .env ]; then
            echo "‚ùå ERROR: .env file is missing! Migrations will fail."
            echo "‚ö†Ô∏è  The .env file should have been copied from GitHub Actions."
            exit 1
          fi
          
          if ! grep -q "DB_USER=" .env || ! grep -q "DB_PASSWORD=" .env || ! grep -q "DB_HOST=" .env || ! grep -q "DB_NAME=" .env; then
            echo "‚ùå ERROR: .env file is missing required database variables!"
            echo "‚ö†Ô∏è  Required: DB_HOST, DB_USER, DB_PASSWORD, DB_NAME"
            exit 1
          fi
          
          echo "‚úÖ .env file verified with all required database variables"
          
          # Run database migrations (if needed)
          echo "üóÑÔ∏è  Running database migrations..."
          npm run migrate || echo "‚ö†Ô∏è  Migration script not found or failed, continuing..."
          
          # Restart/Start PM2 process
          echo "üîÑ Starting/Restarting backend with PM2..."
          # Stop and delete existing process to ensure clean restart
          pm2 delete nikah-backend 2>/dev/null || true
          # Clear PM2 cache and logs
          pm2 flush 2>/dev/null || true
          # Wait a moment for process to fully stop
          sleep 1
          # Start the server with updated code from current directory
          cd /var/www/backend
          pm2 start server.js --name nikah-backend --update-env
          # Wait for process to start
          sleep 3
          # Force reload to ensure latest code is loaded (this clears require cache)
          pm2 reload nikah-backend --update-env || pm2 restart nikah-backend --update-env
          # Wait for reload to complete
          sleep 2
          # Save PM2 process list
          pm2 save
          # Setup PM2 to start on system boot
          pm2 startup 2>/dev/null || true
          
          echo "‚úÖ Backend deployment completed!"
          echo "üìä Current deployed commit:"
          git log -1 --oneline
          echo "üìä PM2 Status:"
          pm2 status
          echo "üìã PM2 Logs (last 20 lines):"
          pm2 logs nikah-backend --lines 20 --nostream || true
          echo "üìÅ Verifying key files are updated:"
          ls -lh server.js src/controllers/applicationController.js src/utils/helpers.js 2>/dev/null || echo "‚ö†Ô∏è  Some files not found"
          EOF
          
          # Ensure /var/www directory exists
          echo "üìÅ Ensuring /var/www directory exists..."
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_HOST }} 'mkdir -p /var/www && chmod 755 /var/www'
          
          # Copy deploy script to server first
          echo "üì§ Copying deployment script to server..."
          sshpass -p "$SSH_PASSWORD" scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null deploy-backend.sh ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_HOST }}:/tmp/deploy-backend.sh
          
          # Copy .env file to server BEFORE running deployment script
          echo "üìù Copying .env file to server..."
          sshpass -p "$SSH_PASSWORD" scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null backend/.env ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_HOST }}:/var/www/backend/.env
          echo "‚úÖ .env file copied to server"
          
          # Execute deployment script
          echo "üöÄ Executing deployment script..."
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_HOST }} 'bash /tmp/deploy-backend.sh && rm /tmp/deploy-backend.sh'

      - name: ‚úÖ Verify deployment
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          sleep 5
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_HOST }} 'pm2 status nikah-backend'
          echo "‚úÖ Deployment verification completed"
