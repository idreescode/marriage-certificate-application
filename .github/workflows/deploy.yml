name: Deploy to cPanel (FTP)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name:  Checkout Code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      # ----------------------------------------------------------------
      # FRONTEND BUILD
      # ----------------------------------------------------------------
      - name: üî® Install Frontend Dependencies
        run: |
          cd frontend
          npm ci

      - name: üèóÔ∏è Build Frontend
        run: |
          cd frontend
          npm run build
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}

      # ----------------------------------------------------------------
      # PREPARE DEPLOYMENT FILES
      # ----------------------------------------------------------------
      - name: üìÇ Prepare Deployment Files
        run: |
          mkdir deploy_artifact
          
          # 1. Copy Backend (Source Code)
          cp -r backend/* deploy_artifact/
          
          # 2. Copy Frontend Build (to public/dist or wherever static files are served)
          # Assuming your backend is configured to serve '../frontend/dist' or specific folder
          # Creating standard structure:
          mkdir -p deploy_artifact/frontend_build
          cp -r frontend/dist/* deploy_artifact/frontend_build/

          # 3. Create Restart Trigger for cPanel (Phusion Passenger/Node)
          mkdir -p deploy_artifact/tmp
          touch deploy_artifact/tmp/restart.txt

          # Cleanup node_modules (too big for FTP, run npm install on server if possible OR upload dependencies if no SSH)
          # NOTE: Uploading node_modules via FTP is slow. 
          # IF YOU CANNOT RUN npm install ON SERVER via SSH Terminal:
          # You MUST build node_modules here. But linux binaries might not match cPanel.
          # Best practice for FTP-only: Upload package.json and trigger install on server if possible.
          # For now, we assume dependency updates are rare or manual.
          
      # ----------------------------------------------------------------
      # FTP DEPLOY
      # ----------------------------------------------------------------
      - name: üöÄ Deploy via FTP
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          server-dir: /public_html/  # CHANGE THIS to your actual path (e.g., / or /app)
          local-dir: ./deploy_artifact/
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**

