name: Deploy Backend to IONOS Server

on:
  push:
    branches: [main, master]
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üìù Create .env file
        working-directory: ./backend
        run: |
          cat > .env << EOF
          PORT=${{ secrets.BACKEND_PORT || '5000' }}
          NODE_ENV=production
          DB_HOST=${{ secrets.DB_HOST }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_NAME=${{ secrets.DB_NAME }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          EMAIL_HOST=${{ secrets.EMAIL_HOST }}
          EMAIL_PORT=${{ secrets.EMAIL_PORT }}
          EMAIL_USER=${{ secrets.EMAIL_USER }}
          EMAIL_PASS=${{ secrets.EMAIL_PASS }}
          FRONTEND_URL=${{ secrets.FRONTEND_URL || 'https://nikahapp.jamiyat.org' }}
          EOF
          echo "‚úÖ .env file created"

      - name: üîß Install sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

      - name: üîç Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: üì§ Deploy to server
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          # Create deployment script
          REPO_URL="https://github.com/${{ github.repository }}.git"
          cat > deploy-backend.sh << EOF
          #!/bin/bash
          set -e
          
          echo "üöÄ Starting backend deployment..."
          
          # Create backend directory if it doesn't exist
          if [ ! -d "/var/www/backend" ]; then
            echo "üìÅ Creating /var/www/backend directory..."
            mkdir -p /var/www/backend
            chmod 755 /var/www/backend
          fi
          
          # Navigate to backend directory
          cd /var/www/backend || exit 1
          
          # Initialize git repository if it doesn't exist
          if [ ! -d ".git" ]; then
            echo "üîß Initializing git repository..."
            git init
            git remote add origin $REPO_URL || git remote set-url origin $REPO_URL
          fi
          
          # Backup current .env if exists
          if [ -f .env ]; then
            cp .env .env.backup.\$(date +%Y%m%d_%H%M%S)
            echo "‚úÖ Backed up existing .env"
          fi
          
          # Pull latest code
          echo "üì• Pulling latest code..."
          git fetch origin
          BRANCH_NAME="main"
          if ! git ls-remote --heads origin main | grep -q main; then
            BRANCH_NAME="master"
          fi
          git checkout -b \$BRANCH_NAME origin/\$BRANCH_NAME 2>/dev/null || git checkout \$BRANCH_NAME
          git reset --hard origin/\$BRANCH_NAME
          
          # Remove frontend folder if it exists (we don't need it for backend deployment)
          if [ -d "frontend" ]; then
            echo "üóëÔ∏è  Removing frontend folder..."
            rm -rf frontend
            echo "‚úÖ Frontend folder removed"
          fi
          
          # Move backend files to current directory if they're in a subdirectory
          if [ -d "backend" ] && [ ! -f "package.json" ]; then
            echo "üì¶ Moving backend files to root directory..."
            # Enable moving hidden files
            shopt -s dotglob nullglob
            # Move all files from backend/ to current directory
            mv backend/* . 2>/dev/null || true
            # Remove empty backend directory
            rmdir backend 2>/dev/null || true
            shopt -u dotglob nullglob
            echo "‚úÖ Backend files moved successfully"
          fi
          
          # Verify package.json exists
          if [ ! -f "package.json" ]; then
            echo "‚ùå Error: package.json not found!"
            echo "Current directory contents:"
            ls -la
            exit 1
          fi
          
          echo "‚úÖ Verified: package.json found at \$(pwd)/package.json"
          
          # Create uploads directory if it doesn't exist
          if [ ! -d "uploads" ]; then
            echo "üìÅ Creating uploads directory..."
            mkdir -p uploads/receipts uploads/certificates
            chmod -R 755 uploads
          fi
          
          # Install/update dependencies
          echo "üì¶ Installing dependencies..."
          # Always use npm install (simpler, handles lock file sync automatically)
          npm install --omit=dev
          
          # Run database migrations (if needed)
          echo "üóÑÔ∏è  Running database migrations..."
          npm run migrate || echo "‚ö†Ô∏è  Migration script not found or failed, continuing..."
          
          # Restart PM2 process
          echo "üîÑ Restarting backend with PM2..."
          pm2 restart nikah-backend || pm2 start server.js --name nikah-backend
          pm2 save
          
          echo "‚úÖ Backend deployment completed!"
          pm2 status
          EOF
          
          # Ensure /var/www directory exists
          echo "üìÅ Ensuring /var/www directory exists..."
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_HOST }} 'mkdir -p /var/www && chmod 755 /var/www'
          
          # Copy .env and deploy script to server using password
          echo "üì§ Copying files to server..."
          sshpass -p "$SSH_PASSWORD" scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null backend/.env ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_HOST }}:/var/www/backend/.env || echo "‚ö†Ô∏è  .env file copy failed, will be created by script"
          sshpass -p "$SSH_PASSWORD" scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null deploy-backend.sh ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_HOST }}:/tmp/deploy-backend.sh
          
          # Execute deployment script
          echo "üöÄ Executing deployment script..."
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_HOST }} 'bash /tmp/deploy-backend.sh && rm /tmp/deploy-backend.sh'

      - name: ‚úÖ Verify deployment
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          sleep 5
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_HOST }} 'pm2 status nikah-backend'
          echo "‚úÖ Deployment verification completed"
