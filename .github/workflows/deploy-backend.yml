name: Deploy Backend to IONOS Server

on:
  push:
    branches: [main, master]
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“ Create .env file
        working-directory: ./backend
        run: |
          cat > .env << EOF
          PORT=${{ secrets.BACKEND_PORT || '5000' }}
          NODE_ENV=production
          DB_HOST=${{ secrets.DB_HOST }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_NAME=${{ secrets.DB_NAME }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          EMAIL_HOST=${{ secrets.EMAIL_HOST }}
          EMAIL_PORT=${{ secrets.EMAIL_PORT }}
          EMAIL_USER=${{ secrets.EMAIL_USER }}
          EMAIL_PASS=${{ secrets.EMAIL_PASS }}
          FRONTEND_URL=${{ secrets.FRONTEND_URL || 'https://nikahapp.jamiyat.org' }}
          EOF
          echo "âœ… .env file created"

      - name: ðŸ”§ Install sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

      - name: ðŸ” Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: ðŸ“¤ Deploy to server
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          # Create deployment script
          REPO_URL="https://github.com/${{ github.repository }}.git"
          cat > deploy-backend.sh << EOF
          #!/bin/bash
          set -e
          
          echo "ðŸš€ Starting backend deployment..."
          
          # Create backend directory if it doesn't exist
          if [ ! -d "/var/www/backend" ]; then
            echo "ðŸ“ Creating /var/www/backend directory..."
            mkdir -p /var/www/backend
            chmod 755 /var/www/backend
          fi
          
          # Navigate to backend directory
          cd /var/www/backend || exit 1
          
          # Initialize git repository if it doesn't exist
          if [ ! -d ".git" ]; then
            echo "ðŸ”§ Initializing git repository..."
            git init
            git remote add origin $REPO_URL || git remote set-url origin $REPO_URL
          fi
          
          # Create uploads directory if it doesn't exist
          if [ ! -d "uploads" ]; then
            echo "ðŸ“ Creating uploads directory..."
            mkdir -p uploads/receipts uploads/certificates
            chmod -R 755 uploads
          fi
          
          # Backup current .env if exists
          if [ -f .env ]; then
            cp .env .env.backup.\$(date +%Y%m%d_%H%M%S)
            echo "âœ… Backed up existing .env"
          fi
          
          # Pull latest code
          echo "ðŸ“¥ Pulling latest code..."
          git fetch origin
          git reset --hard origin/main || git reset --hard origin/master
          
          # Install/update dependencies
          echo "ðŸ“¦ Installing dependencies..."
          if [ -f "package-lock.json" ]; then
            npm ci --omit=dev
          else
            echo "âš ï¸  package-lock.json not found, using npm install..."
            npm install --omit=dev
          fi
          
          # Run database migrations (if needed)
          echo "ðŸ—„ï¸  Running database migrations..."
          npm run migrate || echo "âš ï¸  Migration script not found or failed, continuing..."
          
          # Restart PM2 process
          echo "ðŸ”„ Restarting backend with PM2..."
          pm2 restart nikah-backend || pm2 start server.js --name nikah-backend
          pm2 save
          
          echo "âœ… Backend deployment completed!"
          pm2 status
          EOF
          
          # Ensure /var/www directory exists
          echo "ðŸ“ Ensuring /var/www directory exists..."
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_HOST }} 'mkdir -p /var/www && chmod 755 /var/www'
          
          # Copy .env and deploy script to server using password
          echo "ðŸ“¤ Copying files to server..."
          sshpass -p "$SSH_PASSWORD" scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null backend/.env ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_HOST }}:/var/www/backend/.env || echo "âš ï¸  .env file copy failed, will be created by script"
          sshpass -p "$SSH_PASSWORD" scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null deploy-backend.sh ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_HOST }}:/tmp/deploy-backend.sh
          
          # Execute deployment script
          echo "ðŸš€ Executing deployment script..."
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_HOST }} 'bash /tmp/deploy-backend.sh && rm /tmp/deploy-backend.sh'

      - name: âœ… Verify deployment
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          sleep 5
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_HOST }} 'pm2 status nikah-backend'
          echo "âœ… Deployment verification completed"
